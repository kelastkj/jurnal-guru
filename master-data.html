<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Master - Aplikasi Guru</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="main-header">
        <h1>Aplikasi Guru</h1>
        <p id="welcomeMessage">Selamat Datang!</p>
    </header>

    <nav class="desktop-nav">
        <ul id="mainNavDesktop">
            <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="master-data.html" class="active"><i class="fas fa-database"></i> Data Master</a></li>
            <li><a href="attendance.html"><i class="fas fa-user-check"></i> Presensi</a></li>
            <li><a href="journal.html"><i class="fas fa-book-open"></i> Jurnal</a></li>
            <li><a href="assessment.html"><i class="fas fa-graduation-cap"></i> Penilaian</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-line"></i> Rekap</a></li>
            <li><a href="#" id="logoutButtonDesktop"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </nav>

    <div class="app-container">
        <section id="masterDataPage" class="page active">
            <h2><i class="fas fa-database icon-title"></i> Manajemen Data Master</h2>
            <p id="masterMessage"></p>

            <div class="content-card">
                <h3><i class="fas fa-chalkboard"></i> Data Kelas</h3>
                <form id="formTambahKelas" class="mb-2">
                    <div class="form-group">
                        <label for="namaKelas">Nama Kelas Baru:</label>
                        <input type="text" id="namaKelas" placeholder="Contoh: X IPA 1" required>
                    </div>
                    <button type="submit"><i class="fas fa-plus"></i> Tambah Kelas</button>
                </form>
                <h4>Daftar Kelas</h4>
                <div class="table-responsive">
                    <table id="tabelKelas">
                        <thead><tr><th>ID</th><th>Nama Kelas</th></tr></thead>
                        <tbody><tr><td colspan="2">Memuat data...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div class="content-card">
                <h3><i class="fas fa-book"></i> Data Mata Pelajaran</h3>
                <form id="formTambahMapel" class="mb-2">
                    <div class="form-group">
                        <label for="namaMapel">Nama Mata Pelajaran Baru:</label>
                        <input type="text" id="namaMapel" placeholder="Contoh: Matematika Wajib" required>
                    </div>
                    <button type="submit"><i class="fas fa-plus"></i> Tambah Mata Pelajaran</button>
                </form>
                <h4>Daftar Mata Pelajaran</h4>
                <div class="table-responsive">
                    <table id="tabelMapel">
                        <thead><tr><th>ID</th><th>Nama Mata Pelajaran</th></tr></thead>
                        <tbody><tr><td colspan="2">Memuat data...</td></tr></tbody>
                    </table>
                </div>
            </div>

             <div class="content-card">
                <h3><i class="fas fa-user-graduate"></i> Data Siswa</h3>
                <form id="formTambahSiswa" class="mb-2">
                    <div class="form-group">
                        <label for="namaSiswa">Nama Siswa Baru:</label>
                        <input type="text" id="namaSiswa" placeholder="Nama Lengkap Siswa" required>
                    </div>
                    <div class="form-group">
                        <label for="idKelasSiswa">Pilih Kelas:</label>
                        <select id="idKelasSiswa" required>
                            <option value="">-- Pilih Kelas --</option>
                        </select>
                    </div>
                    <button type="submit"><i class="fas fa-user-plus"></i> Tambah Siswa</button>
                </form>
                <h4>Daftar Siswa</h4>
                <div class="table-responsive">
                    <table id="tabelSiswa">
                        <thead><tr><th>ID</th><th>Nama Siswa</th><th>ID Kelas</th></tr></thead>
                        <tbody><tr><td colspan="3">Memuat data...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <nav class="mobile-bottom-nav">
        <a href="dashboard.html" class="nav-item" data-page="dashboard">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="attendance.html" class="nav-item" data-page="attendance">
            <i class="fas fa-user-check"></i>
            <span>Presensi</span>
        </a>
        <a href="journal.html" class="nav-item" data-page="journal">
            <i class="fas fa-book-open"></i>
            <span>Jurnal</span>
        </a>
        <a href="reports.html" class="nav-item" data-page="reports">
            <i class="fas fa-chart-bar"></i>
            <span>Rekap</span>
        </a>
        <a href="#" id="mobileMenuTrigger" class="nav-item">
            <i class="fas fa-bars"></i>
            <span>Menu</span>
        </a>
    </nav>

    <div class="mobile-menu-overlay hidden" id="mobileMenuOverlay">
        <div class="mobile-menu-content">
            <button id="closeMobileMenu" class="close-menu-btn"><i class="fas fa-times"></i></button>
            <h3>Menu Lainnya</h3>
            <ul>
                <li><a href="master-data.html"><i class="fas fa-database"></i> Data Master</a></li>
                <li><a href="assessment.html"><i class="fas fa-graduation-cap"></i> Penilaian</a></li>
                <li><a href="#" id="logoutButtonMobile"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>
    </div>

    <div id="loading" class="hidden">Memproses...</div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginAndSetup();
            setupMobileMenu();
            loadAllMasterData();

            const formTambahKelas = document.getElementById('formTambahKelas');
            const formTambahMapel = document.getElementById('formTambahMapel');
            const formTambahSiswa = document.getElementById('formTambahSiswa');
            const masterMessage = document.getElementById('masterMessage');

            async function loadAllMasterData() {
                if (SCRIPT_URL === "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL") return;
                showLoading();
                const params = new URLSearchParams({ action: 'getMasterData' });
                try {
                    const response = await fetch(SCRIPT_URL, { method: 'POST', body: params });
                    const result = await response.json();
                    if (result.success) {
                        populateTable('tabelKelas', result.kelas, ['ID', 'Nama Kelas']);
                        populateTable('tabelMapel', result.mapel, ['ID', 'Nama Mata Pelajaran']);
                        populateTable('tabelSiswa', result.siswa, ['ID', 'Nama', 'ID Kelas']);
                        populateDropdown('idKelasSiswa', result.kelas, 'ID', 'Nama Kelas');
                    } else {
                        masterMessage.textContent = result.message || "Gagal memuat data master.";
                        masterMessage.style.color = 'red';
                    }
                } catch (error) {
                    masterMessage.textContent = "Error: " + error; masterMessage.style.color = 'red';
                } finally {
                    hideLoading();
                }
            }

            async function handleAddMasterData(formElement, actionName, dataPayload) {
                if (SCRIPT_URL === "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL") return;
                showLoading();
                masterMessage.textContent = '';
                const params = new URLSearchParams({ action: actionName, ...dataPayload });
                try {
                    const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
                    const data = await res.json();
                    masterMessage.textContent = data.message;
                    masterMessage.style.color = data.success ? 'green' : 'red';
                    if (data.success) {
                        formElement.reset();
                        loadAllMasterData(); // Reload
                    }
                } catch (err) {
                    masterMessage.textContent = "Error: " + err; masterMessage.style.color = 'red';
                } finally {
                    hideLoading();
                }
            }

            formTambahKelas.addEventListener('submit', (e) => {
                e.preventDefault();
                const namaKelas = document.getElementById('namaKelas').value;
                if (!namaKelas) return;
                handleAddMasterData(formTambahKelas, 'addKelas', { namaKelas });
            });

            formTambahMapel.addEventListener('submit', (e) => {
                e.preventDefault();
                const namaMapel = document.getElementById('namaMapel').value;
                if (!namaMapel) return;
                handleAddMasterData(formTambahMapel, 'addMapel', { namaMapel });
            });

            formTambahSiswa.addEventListener('submit', (e) => {
                e.preventDefault();
                const namaSiswa = document.getElementById('namaSiswa').value;
                const idKelasSiswa = document.getElementById('idKelasSiswa').value;
                if (!namaSiswa || !idKelasSiswa) return;
                handleAddMasterData(formTambahSiswa, 'addSiswa', { namaSiswa, idKelasSiswa });
            });
        });
    </script>
</body>
</html>